# Техническое Задание (ТЗ) для проекта ilinks

# 1. Общая информация

*   **Название проекта:** ilinks
*   **Цель проекта:** Создание инструмента для анализа структуры внутренних ссылок сайтов на WordPress из списка и экспорта данных в отдельные CSV-файлы, добавляя название сайта к имени файла.
*   **Целевая аудитория:** SEO-специалисты, веб-мастера, контент-менеджеры, владельцы сайтов на WordPress.

# 2. Структура проекта

```
ilinks/
├── config.py
├── core/
│ ├── api_client.py
│ ├── link_extractor.py
│ ├── data_processor.py
│ └── utils.py
├── output/
│ ├── internal_links_site1.csv # Пример CSV-файла для сайта 1
│ ├── internal_links_site2.csv # Пример CSV-файла для сайта 2
│ └── ...
├── main.py
└── README.md
```


# 3. Описание модулей и файлов

*   **`config.py`:** Файл конфигурации, содержащий основные параметры работы скрипта, включая список сайтов для анализа.
*   **`core/api_client.py`:** Модуль, отвечающий за взаимодействие с WordPress REST API.
    *   Функции:
        *   `get_all_posts(base_url)`: Получает список всех статей для указанного сайта.
        *   `get_post_content(base_url, post_id)`: Получает контент статьи и данные из поля `acf` по ее ID из WordPress REST API.
*   **`core/link_extractor.py`:** Модуль, отвечающий за извлечение внутренних ссылок из контента статьи.
    *   Функции:
        *   `extract_internal_links(post_content, base_url)`: Извлекает внутренние ссылки, используя регулярные выражения.
        *   `extract_acf_links(acf_data)`: Извлекает ID статей из поля `related-posts` в данных `acf`.
        *   `resolve_slug_to_id(base_url, slug)`:  По slug пытается получить id поста, страницы или категории.  Если не находит, возвращает None
*   **`core/data_processor.py`:** Модуль, отвечающий за обработку данных, подсчет входящих ссылок и построение DataFrame.
    *   Функции:
        *   `calculate_incoming_links(all_posts, links_per_post)`: Вычисляет входящие ссылки.
        *   `build_dataframe(all_posts, links_per_post, incoming_links)`: Строит DataFrame.
*   **`core/utils.py`:** Модуль для вспомогательных функций (например, логирование).
*   **`output/internal_links_*.csv`:** CSV-файлы, которые будут сгенерированы скриптом для каждого сайта.
*   **`main.py`:** Основной скрипт, который запускает весь процесс анализа для каждого сайта из списка.
*   **`README.md`:** Описание проекта и инструкции по использованию.

# 4. Входные данные

*   **`config.py`:**
    *   `SITES` (обязательно): Список словарей, где каждый словарь содержит:
        *   `url` (строка): Базовый URL сайта WordPress (например, `"https://ваш-сайт.com"`).
        *   `name` (строка): Короткое название сайта (используется в имени CSV-файла, например `"site1"`).
    *   `CSV_FILENAME` (обязательно): Шаблон имени файла для сохранения CSV (например, `"output/internal_links_{site_name}.csv"`).
    *   **(Опционально) `ACF_FIELD_NAME` (строка): Название поля ACF, содержащего список связанных статей. По умолчанию `"related-posts"`**
    *   **(Опционально) `IGNORE_NON_POSTS` (boolean): Указывать, нужно ли учитывать ссылки на страницы и категории. По умолчанию `True` (игнорировать).**

# 5. Выходные данные

*   CSV-файлы (например, `output/internal_links_site1.csv`, `output/internal_links_site2.csv` и т.д.) для каждого сайта из списка `SITES` со следующими характеристиками:
    *   Разделитель полей: точка с запятой (`;`).
    *   Кодировка файла: UTF-8.
    *   Формат списков ID статей: список ID, разделенных запятыми (например, `"123,456,789"`).
    *   Колонки:
        *   `post_id` (integer): ID статьи
        *   `post_slug` (string): Slug статьи
        *   `outgoing_count` (integer): Сколько исходящих ссылок
        *   `outgoing_links` (string): Список ID статей, на которые ссылаемся (разделенных запятыми)
        *   `incoming_count` (integer): Сколько входящих ссылок
        *   `incoming_links` (string): Список ID статей, из которых ссылки (разделенных запятыми)

# 6. Основные ограничения

*   **Ограничение по времени выполнения:** Скрипт должен выполняться за разумное время (например, не более 1 часа на сайт) для сайтов с количеством статей до 1000.
*   **Ограничение по памяти:** Скрипт не должен потреблять слишком много памяти (например, не более 1 ГБ на сайт) для сайтов с количеством статей до 1000.
*   **Зависимость от REST API WordPress:** Скрипт зависит от доступности и стабильности WordPress REST API для каждого сайта.
*   **Структура контента WordPress:** Скрипт предполагает, что контент статей отформатирован стандартным образом и что внутренние ссылки создаются с использованием тегов `<a>` для каждого сайта.
*   **Наличие ACF:** Скрипт предполагает, что на сайтах используется ACF и поле с именем, указанным в config.py (по умолчанию `"related-posts"`), содержит список ID связанных статей.
*   **Обработка ссылок на страницы и категории:** Скрипт позволяет игнорировать ссылки на страницы и категории, если это указано в `config.py`.

# 7. Основные функции

*   **Получение списка статей для каждого сайта:** Получение списка всех статей с их ID и slug из WordPress REST API для каждого сайта из списка.
*   **Извлечение ссылок из контента статьи для каждого сайта:** Извлечение внутренних ссылок из контента каждой статьи с использованием регулярных выражений, а также из поля `acf`. Обработка ссылок на посты, страницы и категории.
*   **Подсчет входящих ссылок для каждого сайта:** Эффективный подсчет входящих ссылок для каждой статьи для каждого сайта.
*   **Построение DataFrame для каждого сайта:** Создание pandas DataFrame с информацией о статьях и их связях для каждого сайта.
*   **Сортировка DataFrame:** Сортировка DataFrame по столбцу `incoming_count` по убыванию.
*   **Экспорт в CSV для каждого сайта:** Экспорт DataFrame в отдельный CSV-файл с добавлением названия сайта в имя файла.
*   **Логирование:** Запись информации о процессе выполнения скрипта в лог-файл.

# 8. Файл конфигурации (`config.py`)

```python
# config.py

SITES = [
    {"url": "https://site1.com", "name": "site1"},
    {"url": "https://site2.com", "name": "site2"},
    {"url": "https://site3.com", "name": "site3"},
]
CSV_FILENAME = "output/internal_links_{site_name}.csv"  # Шаблон имени файла
ACF_FIELD_NAME = "related-posts" #  Название поля ACF (default: related-posts)
IGNORE_NON_POSTS = True # Игнорировать страницы и категории (default: True)
```

# 9. Переменные и константы

*   `SITES` (список словарей): Список сайтов для анализа (из `config.py`).
*   `CSV_FILENAME` (строка): Шаблон имени файла для сохранения CSV (из `config.py`).
*   `base_url` (строка): Базовый URL текущего сайта WordPress.
*   `site_name` (строка): Название текущего сайта.
*   `csv_filename` (строка): Имя файла CSV для текущего сайта.
*   `all_posts` (список словарей): Список всех статей (ID, slug) для текущего сайта.
*   `links_per_post` (словарь): Словарь, где ключ - ID статьи, значение - список ID статей, на которые она ссылается (для текущего сайта).
*   `incoming_links` (словарь): Словарь, где ключ - ID статьи, значение - список ID статей, которые на нее ссылаются (для текущего сайта).
*   `df` (DataFrame): pandas DataFrame с данными о связях между статьями (для текущего сайта).
    *   `acf_links` (список целых чисел): Список ID статей, полученных из поля `acf` для текущей статьи.
    *   `IGNORE_NON_POSTS` (boolean): Значение параметра `IGNORE_NON_POSTS` из `config.py`.

# 10. Обработка ошибок и исключений

*   **Общие принципы:**

    *   Скрипт должен корректно обрабатывать возможные ошибки и исключения, возникающие в процессе работы для каждого сайта.
    *   Обработка ошибок должна быть реализована с использованием блоков `try...except`.
    *   В случае возникновения ошибки для конкретного сайта, скрипт должен залогировать информацию об ошибке и, по возможности, перейти к анализу следующего сайта.
*   **Конкретные типы исключений и способы их обработки:**

    | Тип исключения                               | Описание                                                                                                                                                                                                            | Действия при возникновении                                                                                                                                                                                                                                          |
    | --------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | `requests.exceptions.RequestException`      | Ошибка при выполнении HTTP-запроса (например, отсутствие соединения, таймаут, ошибка на сервере).                                                                                                                    | Залогировать ошибку с использованием модуля `logging`. Повторить попытку выполнить запрос (не более 3 раз) с экспоненциальной задержкой (1, 2, 4 секунды). Если повторные попытки не удались, прервать обработку текущего сайта и перейти к следующему.              |
    | `KeyError`                                     | Попытка доступа к несуществующему ключу в словаре (например, при разборе JSON-ответа или при обращении к словарю `incoming_links`).                                                                               | Залогировать ошибку с указанием ключа, вызвавшего исключение. Продолжить выполнение для текущего сайта, пропустив текущую операцию (например, если не найден slug статьи, пропустить обработку ссылки).                                                                       |
    | `ValueError`                                   | Ошибка при преобразовании типов данных (например, при попытке преобразовать строку в число).                                                                                                                     | Залогировать ошибку с указанием значения, вызвавшего исключение.  Продолжить выполнение для текущего сайта, используя значение по умолчанию (например, если не удалось преобразовать ID статьи в число, использовать `-1`).                                                              |
    | `AttributeError`                               | Попытка доступа к полю `acf`, если оно отсутствует в ответе API.                                                                                                                                              | Залогировать ошибку и продолжить выполнение, не добавляя ссылки из `acf`.                                                                                                                                                                                              |
    | `Exception` (общее исключение)                | Любая другая непредвиденная ошибка.                                                                                                                                                                                | Залогировать ошибку с максимально подробной информацией (текст исключения, трассировка стека).  Прервать выполнение анализа текущего сайта и перейти к следующему (если дальнейшее выполнение может привести к некорректным результатам) или продолжить (если ошибка не критична).                                 |

*   **Логирование:**

    *   Использовать модуль `logging` для записи информации об ошибках, предупреждениях и других важных событий для каждого сайта.
    *   Определить формат записи логов:  `"%(asctime)s - %(levelname)s - %(message)s"`.
    *   Настроить уровень логирования (например, `INFO`, `WARNING`, `ERROR`).
    *   Предусмотреть возможность записи логов в файл и/или в консоль.

# 11. Требования к производительности и масштабируемости

*   **Целевое время выполнения:**

    *   Для каждого сайта с количеством статей до 500:  не более 5 минут.
    *   Для каждого сайта с количеством статей до 5000: не более 30 минут.
    *   Для сайтов с количеством статей свыше 5000: необходимо провести дополнительное тестирование и оптимизацию.
*   **Максимальный объем памяти:** Скрипт не должен потреблять более 512 МБ оперативной памяти на сайт.
*   **Оптимизация:**

    *   При необходимости, рассмотреть возможность использования многопоточности или асинхронности для ускорения выполнения скрипта (особенно для больших сайтов).
    *   Оптимизировать алгоритмы обработки данных, чтобы минимизировать использование памяти.

# 12. Масштабируемость и поддержка

*   **Документирование кода:**

    *   Код должен быть хорошо документирован с использованием docstring-ов для каждой функции и класса.
    *   Docstring-и должны содержать описание назначения функции/класса, входных и выходных данных, а также примеры использования (если это уместно).
    *   Важные участки кода должны быть прокомментированы для пояснения логики работы.
*   **Поддержка:**

    *   Код должен быть написан таким образом, чтобы его было легко понимать и поддерживать другими разработчиками.
    *   Использовать понятные имена переменных и функций.
    *   Избегать сложной и запутанной логики.

# 13. Дальнейшее развитие

*   Добавление подсчета ссылок с главной страницы сайта.
*   Доработка логики для обработки `page_id` и `category_id` в `links_per_post` и в `build_dataframe` (в случае, если `IGNORE_NON_POSTS = False`).